---
/**
 * Calculator Layout - Dark Theme
 *
 * Extends BaseLayout with calculator-specific features:
 * - Related calculators section
 * - Schema.org markup slots
 * - Ad placements (top, bottom, sidebar)
 */

import BaseLayout from './BaseLayout.astro';
import AdUnit from '../components/common/AdUnit.astro';

export interface RelatedCalculator {
  title: string;
  description: string;
  href: string;
  icon: string;
  color: 'blue' | 'green' | 'purple' | 'red' | 'yellow' | 'coral' | 'violet' | 'ocean' | 'amber';
}

export interface Props {
  title: string;
  description: string;
  keywords?: string;
  canonicalURL?: string;
  relatedCalculators?: RelatedCalculator[];
  showAds?: boolean;
  ogImage?: string;
}

const {
  title,
  description,
  keywords,
  canonicalURL,
  relatedCalculators = [],
  showAds = false,
  ogImage,
} = Astro.props;

// Auto-generate OG image path from canonical URL if not provided
const calculatorOgImage =
  ogImage ||
  (() => {
    if (canonicalURL) {
      // Extract calculator slug from URL like "/calculators/tip-calculator"
      const match = canonicalURL.match(/\/calculators\/([^\/]+)/);
      if (match) {
        return `/og/${match[1]}.png`;
      }
    }
    return '/og/default.png';
  })();

// Icon paths for related calculator cards
const iconPaths: Record<string, string> = {
  dollar:
    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />',
  calculator:
    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />',
  chart:
    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />',
  trending:
    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />',
  cube: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />',
  shield:
    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />',
  bolt: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z" />',
  fire: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />',
  percent:
    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />',
  glass:
    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />',
};

// Color classes for icons (dark theme)
const colorClasses: Record<string, string> = {
  blue: 'from-blue-500 to-blue-600',
  green: 'from-emerald-500 to-emerald-600',
  purple: 'from-violet-500 to-purple-600',
  violet: 'from-violet-500 to-purple-600',
  red: 'from-rose-500 to-red-500',
  coral: 'from-rose-500 to-red-500',
  yellow: 'from-amber-500 to-orange-500',
  amber: 'from-amber-500 to-orange-500',
  ocean: 'from-cyan-500 to-teal-500',
};
---

<BaseLayout
  title={title}
  description={description}
  keywords={keywords}
  canonicalURL={canonicalURL}
  ogImage={calculatorOgImage}
>
  <!-- Schema.org markup slot -->
  <slot name="schema" />

  <div class="max-w-6xl mx-auto px-6 py-8">
    <!-- Two Column Layout: Main Content + Sidebar -->
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Main Content -->
      <article class="flex-1 min-w-0">
        <!-- Top Ad Unit (horizontal banner) - Hidden on mobile -->
        <div class="hidden lg:block mb-6">
          <AdUnit slot="9991282844" format="horizontal" className="rounded-xl overflow-hidden" />
        </div>

        <!-- Main Content Slot -->
        <slot />

        <!-- Mid-content Ad Unit (shows after calculator, before related) -->
        <div class="my-8">
          <AdUnit slot="8151016743" format="horizontal" className="rounded-xl overflow-hidden" />
        </div>

        <!-- Related Calculators Section -->
        {
          relatedCalculators.length > 0 && (
            <section class="mt-16 mb-12">
              <h2 class="text-xl md:text-2xl font-display text-[var(--color-cream)] mb-6 break-words">
                Related Calculators
              </h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {relatedCalculators.map((calc) => {
                  const gradientClass = colorClasses[calc.color] || colorClasses.blue;
                  return (
                    <a href={calc.href} class="group bento-card glow flex items-start gap-4">
                      <div
                        class={`w-12 h-12 bg-gradient-to-br ${gradientClass} rounded-xl flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform duration-300`}
                      >
                        <svg
                          class="w-6 h-6 text-white"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <Fragment set:html={iconPaths[calc.icon] || iconPaths.calculator} />
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <h3 class="font-display text-lg text-[var(--color-cream)] group-hover:text-[var(--color-accent)] transition-colors">
                          {calc.title}
                        </h3>
                        <p class="text-[var(--color-subtle)] text-sm mt-1 line-clamp-2">
                          {calc.description}
                        </p>
                      </div>
                      <svg
                        class="w-5 h-5 text-[var(--color-muted)] group-hover:text-[var(--color-accent)] group-hover:translate-x-1 transition-all flex-shrink-0 mt-1"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 5l7 7-7 7"
                        />
                      </svg>
                    </a>
                  );
                })}
              </div>
            </section>
          )
        }

        <!-- Bottom Ad Unit -->
        <div class="my-8">
          <AdUnit slot="4738956161" className="rounded-xl overflow-hidden" />
        </div>

        <!-- Call to Action -->
        <section class="card-elevated rounded-2xl p-8 text-center relative overflow-hidden">
          <!-- Background glow -->
          <div class="absolute inset-0 overflow-hidden pointer-events-none" aria-hidden="true">
            <div
              class="absolute -top-12 -right-12 w-32 h-32 bg-[var(--color-accent)]/10 rounded-full blur-2xl"
            >
            </div>
            <div
              class="absolute -bottom-12 -left-12 w-32 h-32 bg-violet-500/10 rounded-full blur-2xl"
            >
            </div>
          </div>

          <div class="relative">
            <h2 class="text-xl font-display text-[var(--color-cream)] mb-2">
              Found this calculator helpful?
            </h2>
            <p class="text-[var(--color-subtle)] mb-6">
              Check out our other free calculators for everyday math problems.
            </p>
            <a href="/#calculators" class="btn-primary inline-flex">
              View All Calculators
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
              </svg>
            </a>
          </div>
        </section>
      </article>

      <!-- Sidebar -->
      <aside class="hidden lg:block w-72 flex-shrink-0">
        <div class="sticky top-24 space-y-6">
          <!-- Quick Links Card - Related Calculators (prioritized above ads) -->
          {
            relatedCalculators.length > 0 && (
              <div class="bento-card p-5">
                <h3 class="text-sm font-medium text-[var(--color-cream)] mb-4">Quick Links</h3>
                <ul class="space-y-3">
                  {relatedCalculators.slice(0, 3).map((calc) => {
                    const gradientClass = colorClasses[calc.color] || colorClasses.blue;
                    return (
                      <li>
                        <a
                          href={calc.href}
                          class="group flex items-center gap-3 text-sm text-[var(--color-subtle)] hover:text-[var(--color-accent)] transition-colors"
                        >
                          <div
                            class={`w-7 h-7 bg-gradient-to-br ${gradientClass} rounded-lg flex items-center justify-center flex-shrink-0`}
                          >
                            <svg
                              class="w-4 h-4 text-white"
                              fill="none"
                              stroke="currentColor"
                              viewBox="0 0 24 24"
                            >
                              <Fragment set:html={iconPaths[calc.icon] || iconPaths.calculator} />
                            </svg>
                          </div>
                          <span class="line-clamp-1">{calc.title}</span>
                        </a>
                      </li>
                    );
                  })}
                  <li class="pt-2 border-t border-white/10">
                    <a
                      href="/"
                      class="text-sm text-[var(--color-muted)] hover:text-[var(--color-accent)] transition-colors flex items-center gap-2"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="1.5"
                          d="M4 6h16M4 12h16M4 18h16"
                        />
                      </svg>
                      View All Calculators
                    </a>
                  </li>
                </ul>
              </div>
            )
          }

          <!-- Sidebar Ad Units -->
          <AdUnit slot="1563990305" format="vertical" className="rounded-xl overflow-hidden" />
          <AdUnit slot="8459010640" format="vertical" className="rounded-xl overflow-hidden" />
        </div>
      </aside>
    </div>
  </div>
</BaseLayout>
