---
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
// Local fonts - faster than Google Fonts, no external requests
import '@fontsource/space-grotesk/400.css';
import '@fontsource/space-grotesk/500.css';
import '@fontsource/space-grotesk/600.css';
import '@fontsource/instrument-serif/400.css';
import '@fontsource/instrument-serif/400-italic.css';
import Analytics from '../components/common/Analytics.astro';
import CookieConsent from '../components/common/CookieConsent.astro';
import AdBlockDetector from '../components/common/AdBlockDetector.astro';
import InstallPrompt from '../components/common/InstallPrompt.astro';

export interface Props {
  title?: string;
  description?: string;
  keywords?: string;
  canonicalURL?: string;
  ogImage?: string;
}

const {
  title = 'Boring Math Calculators | Free Online Calculators',
  description = 'Free online calculators for everyday math problems. Calculate freelance rates, wedding costs, savings goals, and more.',
  keywords = 'calculator, online calculator, free calculator, math calculator',
  canonicalURL = Astro.url.pathname,
  ogImage,
} = Astro.props;

const siteURL = Astro.site || 'https://boring-math.com';
const fullCanonicalURL = new URL(canonicalURL, siteURL).href;
const currentPath = Astro.url.pathname;

// Determine OG image: use custom if provided, otherwise default
const ogImageURL = ogImage
  ? new URL(ogImage, siteURL).href
  : new URL('/og/default.webp', siteURL).href;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="generator" content={Astro.generator} />
    <meta name="theme-color" content="#07070a" />
    <meta
      name="robots"
      content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"
    />

    <!-- Fonts loaded locally via @fontsource for faster LCP -->

    <!-- Canonical URL -->
    <link rel="canonical" href={fullCanonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={fullCanonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={fullCanonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />

    <!-- Open Graph / Social Image -->
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={title} />
    <meta name="twitter:image" content={ogImageURL} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#07070a" />

    <!-- Google Analytics -->
    <Analytics />

    <!-- Google AdSense -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8014911033000505"
      crossorigin="anonymous"></script>

    <!-- Centralized ad initializer (handles ViewTransitions re-navigation) -->
    <script is:inline>
      document.addEventListener('astro:page-load', function () {
        var ads = document.querySelectorAll('ins.adsbygoogle');
        for (var i = 0; i < ads.length; i++) {
          if (ads[i].getAttribute('data-adsbygoogle-status')) continue;
          var container = ads[i].closest('[data-ad-lazy]');
          var isLazy = container && container.getAttribute('data-ad-lazy') === 'true';
          if (isLazy && 'IntersectionObserver' in window) {
            (function (el) {
              var obs = new IntersectionObserver(
                function (entries) {
                  if (entries[0].isIntersecting) {
                    try {
                      (adsbygoogle = window.adsbygoogle || []).push({});
                    } catch (e) {}
                    obs.disconnect();
                  }
                },
                { rootMargin: '200px' }
              );
              obs.observe(el);
            })(container);
          } else {
            try {
              (adsbygoogle = window.adsbygoogle || []).push({});
            } catch (e) {}
          }
        }
      });
    </script>

    <title>{title}</title>

    <!-- Organization Schema for Google Logo & Knowledge Panel -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'Organization',
        name: 'Boring Math',
        url: 'https://boring-math.com',
        logo: {
          '@type': 'ImageObject',
          url: 'https://boring-math.com/logo.png',
          width: 512,
          height: 512,
          caption: 'Boring Math Calculators Logo',
        },
        image: 'https://boring-math.com/logo.png',
        description:
          'Free online calculators for everyday math problems. Making boring math surprisingly delightful.',
        foundingDate: '2024',
        sameAs: [],
      })}
    />

    <!-- View Transitions for instant navigation -->
    <ViewTransitions fallback="swap" />
  </head>
  <body class="min-h-screen mesh-bg noise relative">
    <!-- Skip Link for Keyboard Navigation -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-[100] focus:px-4 focus:py-2 focus:bg-[var(--color-accent)] focus:text-[var(--color-void)] focus:rounded-lg focus:outline-none"
    >
      Skip to main content
    </a>

    <!-- Ambient Glow Background -->
    <div class="fixed inset-0 pointer-events-none overflow-hidden -z-10" aria-hidden="true">
      <div
        class="absolute top-[-20%] left-[-10%] w-[60vw] h-[60vw] rounded-full bg-[var(--color-accent)] opacity-[0.03] blur-[100px] animate-blob"
      >
      </div>
      <div
        class="absolute bottom-[-20%] right-[-10%] w-[50vw] h-[50vw] rounded-full bg-[var(--color-violet)] opacity-[0.04] blur-[100px] animate-blob"
        style="animation-delay: -4s;"
      >
      </div>
      <div
        class="absolute top-[40%] right-[20%] w-[30vw] h-[30vw] rounded-full bg-[var(--color-ocean)] opacity-[0.03] blur-[80px] animate-pulse-glow"
      >
      </div>
    </div>

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 glass-subtle">
      <nav class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <!-- Logo -->
          <a
            href="/"
            class="group flex items-center gap-3 shrink-0"
            aria-label="Boring Math — Free Online Calculators"
          >
            <div
              class="relative w-10 h-10 rounded-xl bg-[var(--color-accent)] flex items-center justify-center overflow-hidden group-hover:scale-105 transition-transform duration-500"
            >
              <span class="font-display text-[var(--color-void)] text-xl font-normal">B</span>
              <div
                class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"
              >
              </div>
            </div>
            <div class="hidden sm:flex flex-col">
              <span
                class="font-display text-xl text-[var(--color-cream)] leading-none tracking-tight"
                >Boring Math</span
              >
              <span class="text-[10px] text-[var(--color-subtle)] uppercase tracking-[0.2em] mt-0.5"
                >Calculators</span
              >
            </div>
          </a>

          <!-- Mobile Header Search (homepage only) -->
          {
            (currentPath === '/' || currentPath === '') && (
              <div class="flex-1 mx-3 md:hidden">
                <div class="relative">
                  <svg
                    class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-[var(--color-muted)]"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    />
                  </svg>
                  <input
                    type="text"
                    id="header-search-input"
                    placeholder="Search..."
                    class="w-full pl-9 pr-3 py-2 bg-[var(--color-charcoal)] border border-white/10 rounded-xl
                         text-sm text-[var(--color-cream)] placeholder:text-[var(--color-muted)]
                         focus:border-[var(--color-accent)] focus:ring-1 focus:ring-[var(--color-accent)]/20
                         transition-all duration-300"
                  />
                </div>
              </div>
            )
          }

          <!-- Desktop Navigation -->
          <div class="hidden md:flex items-center gap-1">
            <a
              href="/"
              class:list={[
                'px-4 py-2 rounded-full text-sm font-medium transition-all duration-300',
                currentPath === '/' || currentPath === '/calculators'
                  ? 'text-[var(--color-void)] bg-[var(--color-accent)]'
                  : 'text-[var(--color-subtle)] hover:text-[var(--color-cream)] hover:bg-white/5',
              ]}
            >
              Calculators
            </a>
            <a
              href="/about"
              class:list={[
                'px-4 py-2 rounded-full text-sm font-medium transition-all duration-300',
                currentPath === '/about'
                  ? 'text-[var(--color-void)] bg-[var(--color-accent)]'
                  : 'text-[var(--color-subtle)] hover:text-[var(--color-cream)] hover:bg-white/5',
              ]}
            >
              About
            </a>
          </div>

          <!-- Mobile Menu Button -->
          <button
            class="md:hidden p-2 rounded-lg text-[var(--color-subtle)] hover:text-[var(--color-cream)] hover:bg-white/5 transition-colors"
            aria-label="Toggle navigation menu"
            aria-expanded="false"
            aria-controls="mobile-menu"
            id="mobile-menu-btn"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>

        <!-- Mobile Menu -->
        <div class="hidden md:hidden mt-4 pb-2" id="mobile-menu">
          <div class="flex flex-col gap-1">
            <a
              href="/"
              class:list={[
                'px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300',
                currentPath === '/' || currentPath === '/calculators'
                  ? 'text-[var(--color-void)] bg-[var(--color-accent)]'
                  : 'text-[var(--color-subtle)] hover:text-[var(--color-cream)] hover:bg-white/5',
              ]}
            >
              Calculators
            </a>
            <a
              href="/about"
              class:list={[
                'px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300',
                currentPath === '/about'
                  ? 'text-[var(--color-void)] bg-[var(--color-accent)]'
                  : 'text-[var(--color-subtle)] hover:text-[var(--color-cream)] hover:bg-white/5',
              ]}
            >
              About
            </a>
          </div>
        </div>
      </nav>
    </header>

    <!-- Spacer for fixed header -->
    <div class="h-[72px]"></div>

    <!-- Main Content -->
    <main id="main-content" class="relative">
      <slot />
    </main>

    <!-- Footer -->
    <footer class="relative mt-32 border-t border-white/5">
      <div class="max-w-7xl mx-auto px-6 py-16">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-12">
          <!-- Brand Column -->
          <div class="md:col-span-5">
            <a
              href="/"
              class="inline-flex items-center gap-3 mb-6"
              aria-label="Boring Math — Free Online Calculators"
            >
              <div
                class="w-10 h-10 rounded-xl bg-[var(--color-accent)] flex items-center justify-center"
              >
                <span class="font-display text-[var(--color-void)] text-xl">B</span>
              </div>
              <span class="font-display text-2xl text-[var(--color-cream)]">Boring Math</span>
            </a>
            <p class="text-[var(--color-subtle)] max-w-sm leading-relaxed">
              Free online calculators for everyday math problems. Making boring math surprisingly
              delightful since 2024.
            </p>
            <div class="flex gap-4 mt-6">
              <span
                class="px-3 py-1 text-xs rounded-full bg-white/5 text-[var(--color-subtle)] border border-white/10"
              >
                100% Free
              </span>
              <span
                class="px-3 py-1 text-xs rounded-full bg-white/5 text-[var(--color-subtle)] border border-white/10"
              >
                Fast Results
              </span>
              <span
                class="px-3 py-1 text-xs rounded-full bg-white/5 text-[var(--color-subtle)] border border-white/10"
              >
                Easy to Use
              </span>
            </div>
          </div>

          <!-- Quick Links -->
          <nav class="md:col-span-3" aria-label="Quick Links">
            <p class="text-micro text-[var(--color-muted)] mb-6">Quick Links</p>
            <ul class="space-y-4">
              <li>
                <a
                  href="/"
                  class="text-[var(--color-subtle)] hover:text-[var(--color-accent)] transition-colors duration-300 text-sm"
                >
                  Home
                </a>
              </li>
              <li>
                <a
                  href="/calculators"
                  class="text-[var(--color-subtle)] hover:text-[var(--color-accent)] transition-colors duration-300 text-sm"
                >
                  All Calculators
                </a>
              </li>
              <li>
                <a
                  href="/about"
                  class="text-[var(--color-subtle)] hover:text-[var(--color-accent)] transition-colors duration-300 text-sm"
                >
                  About
                </a>
              </li>
            </ul>
          </nav>

          <!-- Popular Tools -->
          <nav class="md:col-span-4" aria-label="Popular Calculators">
            <p class="text-micro text-[var(--color-muted)] mb-6">Popular Calculators</p>
            <ul class="space-y-4">
              <li>
                <a
                  href="/calculators/freelance-day-rate-calculator"
                  class="text-[var(--color-subtle)] hover:text-[var(--color-accent)] transition-colors duration-300 text-sm"
                >
                  Freelance Day Rate
                </a>
              </li>
              <li>
                <a
                  href="/calculators/tip-calculator"
                  class="text-[var(--color-subtle)] hover:text-[var(--color-accent)] transition-colors duration-300 text-sm"
                >
                  Tip Calculator
                </a>
              </li>
              <li>
                <a
                  href="/calculators/savings-goal-calculator"
                  class="text-[var(--color-subtle)] hover:text-[var(--color-accent)] transition-colors duration-300 text-sm"
                >
                  Savings Goal
                </a>
              </li>
              <li>
                <a
                  href="/calculators/emergency-fund-calculator"
                  class="text-[var(--color-subtle)] hover:text-[var(--color-accent)] transition-colors duration-300 text-sm"
                >
                  Emergency Fund
                </a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- Bottom Bar -->
        <div
          class="mt-16 pt-8 border-t border-white/5 flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <p class="text-sm text-[var(--color-muted)]">
            &copy; {new Date().getFullYear()} Boring Math Calculators. All rights reserved.
          </p>
          <div class="flex gap-6 text-sm">
            <a
              href="/privacy-policy"
              class="text-[var(--color-muted)] hover:text-[var(--color-cream)] transition-colors"
            >
              Privacy
            </a>
            <a
              href="/terms"
              class="text-[var(--color-muted)] hover:text-[var(--color-cream)] transition-colors"
            >
              Terms
            </a>
            <a
              href="/contact"
              class="text-[var(--color-muted)] hover:text-[var(--color-cream)] transition-colors"
            >
              Contact
            </a>
            <a
              href="/affiliate-disclosure"
              class="text-[var(--color-muted)] hover:text-[var(--color-cream)] transition-colors"
            >
              Affiliates
            </a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Mobile Menu Script - Works with View Transitions -->
    <script>
      function initMobileMenu() {
        const menuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        // Remove existing listener to prevent duplicates
        menuBtn?.replaceWith(menuBtn.cloneNode(true));
        const newMenuBtn = document.getElementById('mobile-menu-btn');

        newMenuBtn?.addEventListener('click', () => {
          const isHidden = mobileMenu?.classList.toggle('hidden');
          // Update aria-expanded for accessibility
          newMenuBtn.setAttribute('aria-expanded', (!isHidden).toString());
        });

        // Close menu on navigation and reset aria-expanded
        mobileMenu?.classList.add('hidden');
        newMenuBtn?.setAttribute('aria-expanded', 'false');
      }

      // Run on initial load
      initMobileMenu();

      // Re-run after View Transitions navigation
      document.addEventListener('astro:page-load', initMobileMenu);
    </script>

    <!-- Cookie Consent Banner -->
    <CookieConsent />

    <!-- Ad Block Detector -->
    <AdBlockDetector />

    <!-- PWA Install Prompt (mobile only) -->
    <InstallPrompt />

    <!-- Service Worker Registration for Offline Support -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/sw.js')
            .then((registration) => {
              // Check for updates periodically
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                if (newWorker) {
                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      // New version available - could show update prompt here
                      console.log('New version available');
                    }
                  });
                }
              });
            })
            .catch((error) => {
              console.log('SW registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>
