---
/**
 * AdUnit Component
 *
 * Reusable Google AdSense ad unit component with lazy loading.
 * Uses IntersectionObserver to defer ad loading until visible,
 * keeping Lighthouse scores high.
 * Only renders in production to avoid ad serving errors during development.
 */

export interface Props {
  slot: string;
  format?: 'auto' | 'fluid' | 'rectangle' | 'vertical' | 'horizontal';
  layout?: string;
  layoutKey?: string;
  className?: string;
  style?: string;
  lazy?: boolean;
}

const {
  slot,
  format = 'auto',
  layout,
  layoutKey,
  className = '',
  style = 'display:block',
  lazy = true,
} = Astro.props;

const isProd = import.meta.env.PROD;
const clientId = import.meta.env.PUBLIC_ADSENSE_ID || 'ca-pub-8014911033000505';
const uniqueId = `ad-${slot}-${Math.random().toString(36).slice(2, 8)}`;
const minHeight = format === 'horizontal' ? 50 : format === 'vertical' ? 250 : 90;
---

{
  isProd && (
    <div class={`ad-container ${className}`} id={uniqueId} data-ad-lazy={lazy ? 'true' : 'false'} style={`min-height:${minHeight}px`}>
      <ins
        class="adsbygoogle"
        style={style}
        data-ad-client={clientId}
        data-ad-slot={slot}
        data-ad-format={format}
        data-full-width-responsive="true"
        data-ad-layout={layout}
        data-ad-layout-key={layoutKey}
      />
    </div>
  )
}

{
  isProd && lazy && (
    <script is:inline define:vars={{ uniqueId }}>
      (function() {
        var el = document.getElementById(uniqueId);
        if (!el) return;
        if ('IntersectionObserver' in window) {
          var obs = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                (window.adsbygoogle = window.adsbygoogle || []).push({});
                obs.disconnect();
              }
            });
          }, { rootMargin: '200px' });
          obs.observe(el);
        } else {
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        }
      })();
    </script>
  )
}

{
  isProd && !lazy && (
    <script is:inline>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  )
}

{
  !isProd && (
    <div class={`ad-placeholder ${className}`}>
      <div class="bg-[var(--color-charcoal)] border border-dashed border-white/20 rounded-xl py-3 px-4 text-center">
        <p class="text-xs text-[var(--color-muted)]">Ad (slot: {slot}{lazy ? ', lazy' : ''})</p>
      </div>
    </div>
  )
}
