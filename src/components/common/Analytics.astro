---
/**
 * Google Analytics 4 Component
 *
 * Only loads in production when GA_ID is configured.
 * Deferred loading for better performance - loads after user interaction or 3s.
 */

const gaId = import.meta.env.PUBLIC_GA_ID;
const isProd = import.meta.env.PROD;
---

{isProd && gaId && (
  <script is:inline define:vars={{ gaId }}>
    (function() {
      function loadGA() {
        if (window.gaLoaded) return;
        window.gaLoaded = true;

        // Load gtag script
        var s = document.createElement('script');
        s.src = 'https://www.googletagmanager.com/gtag/js?id=' + gaId;
        s.async = true;
        document.head.appendChild(s);

        // Initialize gtag
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        window.gtag = gtag;
        gtag('js', new Date());
        gtag('config', gaId, {
          anonymize_ip: true,
          cookie_flags: 'SameSite=None;Secure'
        });

        // Custom event helper
        window.trackEvent = function(eventName, params) {
          gtag('event', eventName, params);
        };

        // Track calculator usage
        window.trackCalculatorUse = function(calculatorName) {
          gtag('event', 'calculator_used', {
            calculator_name: calculatorName,
            calculation_completed: true
          });
        };

        // Track affiliate clicks
        window.trackAffiliateClick = function(partner, calculator, position) {
          gtag('event', 'affiliate_click', {
            affiliate_partner: partner,
            calculator_page: calculator,
            link_position: position || 'default'
          });
        };
      }

      // Stub functions until GA loads
      window.trackEvent = function() {};
      window.trackCalculatorUse = function() {};
      window.trackAffiliateClick = function() {};

      // Load after user interaction or 3 seconds
      var events = ['scroll', 'click', 'keydown', 'touchstart'];
      events.forEach(function(e) {
        window.addEventListener(e, loadGA, { once: true, passive: true });
      });
      setTimeout(loadGA, 3000);
    })();
  </script>
)}
